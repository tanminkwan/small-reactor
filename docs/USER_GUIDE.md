# 사용자 가이드

Face Swap Application의 상세한 사용 방법을 안내합니다.

## 📋 목차

- [시작하기](#시작하기)
- [웹 인터페이스 사용법](#웹-인터페이스-사용법)
- [얼굴 교체](#얼굴-교체)
- [얼굴 추출](#얼굴-추출)
- [Embedding 관리](#embedding-관리)
- [고급 기능](#고급-기능)
- [문제 해결](#문제-해결)

## 🚀 시작하기

### 1. 애플리케이션 실행

```bash
# 가상환경 활성화
venv\Scripts\activate  # Windows
source venv/bin/activate  # Linux/Mac

# 애플리케이션 실행
python gradio_face_manager.py
```

### 2. 웹 브라우저 접속

브라우저에서 `http://localhost:7860`으로 접속하세요.

## 🌐 웹 인터페이스 사용법

### 메인 화면 구성

웹 인터페이스는 3개의 탭으로 구성되어 있습니다:

1. **🔄 얼굴 교체**: 메인 기능 - 얼굴 교체 및 복원
2. **📸 얼굴 추출**: 새로운 얼굴 데이터베이스 구축
3. **📋 Embedding 목록**: 저장된 얼굴 정보 관리

## 🔄 얼굴 교체

### 기본 사용법

1. **타겟 이미지 업로드**
   - "타겟 이미지 업로드" 영역에 이미지를 드래그 앤 드롭
   - 또는 클릭하여 파일 선택
   - 지원 형식: JPG, PNG, GIF, BMP

2. **얼굴 인덱스 선택**
   - 교체할 얼굴 번호를 입력
   - 예시: `1,3,5` (1번, 3번, 5번 얼굴 교체)
   - 비워두면 모든 얼굴 교체

3. **소스 얼굴 선택**
   - 드롭다운에서 교체할 얼굴 선택
   - 이전에 추출한 얼굴들 중에서 선택
   - 🔄 새로고침 버튼으로 목록 업데이트
   - 선택하지 않으면 첫 번째 저장된 얼굴이 자동 선택됨

4. **CodeFormer 복원 설정**
   - 체크박스로 이미지 품질 향상 선택
   - 기본값: 체크됨 (권장)

5. **입 원본유지 설정** (고급 기능)
   - 체크박스로 입 부분 원본 복원 기능 활성화
   - **확장 비율**: 입 마스크 확장 정도 (기본값: 0.2)
   - **가로 스케일**: 입 마스크 가로 크기 조정 (기본값: 1.0)
   - **세로 스케일**: 입 마스크 세로 크기 조정 (기본값: 1.0)
   - **가로 오프셋**: 입 마스크 가로 위치 조정 (기본값: 0)
   - **세로 오프셋**: 입 마스크 세로 위치 조정 (기본값: 0)
   - **사용 시나리오**: 혀를 내밀거나 입에 물체가 있는 경우 왜곡 방지

6. **얼굴 변경 실행**
   - "얼굴 변경" 버튼 클릭
   - 처리 완료 후 결과 이미지 표시

7. **결과 관리**
   - 🗑️ "결과 이미지 삭제" 버튼으로 생성된 파일 삭제
   - 삭제 후 화면 자동 초기화
   - 삭제 성공/실패 상태 메시지 확인

### 얼굴 인덱스 시스템

얼굴은 **왼쪽에서 오른쪽으로, x좌표가 동일하면 위에서 아래 순서**로 번호가 부여됩니다:

#### 🎯 스마트 인덱싱
- **박스 안쪽 표시**: 얼굴 박스 안쪽에 큰 폰트로 번호 표시
- **적응형 크기**: 박스 크기에 비례한 폰트 크기 (1.5~4.0)
- **가독성 향상**: 흰색 배경과 검은색 텍스트로 명확한 대비
- **정확한 배치**: 박스 중앙에 정확히 배치

```
이미지 예시:
[얼굴1] [얼굴2] [얼굴3]
[얼굴4] [얼굴5] [얼굴6]
[얼굴7] [얼굴8] [얼굴9]
```

**인덱스 입력 예시:**
- `1` - 첫 번째 얼굴만 교체
- `1,3,5` - 1번, 3번, 5번 얼굴 교체
- `2-4` - 2번부터 4번까지 교체 (미지원, 개별 입력 필요)
- 비워두기 - 모든 얼굴 교체

### 고급 사용법

#### 특정 얼굴만 교체하기

1. 타겟 이미지 업로드
2. 얼굴 인덱스에 `2,4,6` 입력 (2번, 4번, 6번 얼굴만)
3. 소스 얼굴 선택
4. 얼굴 변경 실행

#### 모든 얼굴 교체하기

1. 타겟 이미지 업로드
2. 얼굴 인덱스를 비워두기
3. 소스 얼굴 선택
4. 얼굴 변경 실행

## 📸 얼굴 추출

### 새로운 얼굴 데이터베이스 구축

1. **이미지 업로드**
   - "이미지 업로드" 영역에 이미지를 드래그 앤 드롭
   - 여러 얼굴이 있는 이미지도 가능

2. **얼굴 추출 실행**
   - "얼굴 추출" 버튼 클릭
   - 첫 번째 얼굴이 자동으로 추출됨

3. **결과 확인**
   - 추출된 얼굴 이미지 표시
   - 저장 경로 및 파일명 확인

### 추출된 파일 저장

추출된 파일들은 `./faces` 디렉토리에 저장됩니다:

```
faces/
├── face.jpg          # 추출된 얼굴 이미지
├── face.json         # 얼굴 임베딩 데이터
├── 소나기asuka.jpg   # 한글 파일명도 지원
└── 소나기asuka.json
```

## 📋 Embedding 관리

### 저장된 얼굴 목록 확인

"Embedding 목록" 탭에서 현재 저장된 모든 얼굴을 갤러리 형태로 확인할 수 있습니다:

- **갤러리 보기**: 4열 2행 레이아웃으로 저장된 얼굴 이미지 표시
- **파일명**: 각 이미지에 파일명이 캡션으로 표시
- **미리보기**: 이미지 클릭 시 확대 미리보기 가능
- **실시간 업데이트**: 새로고침 버튼으로 최신 상태 반영

### 얼굴 데이터 관리

#### 파일 시스템에서 직접 관리

```bash
# faces 디렉토리 구조
faces/
├── face.jpg          # 얼굴 이미지
├── face.json         # 임베딩 데이터
├── person1.jpg       # 다른 사람의 얼굴
├── person1.json      # 해당 임베딩
└── ...
```

#### 파일 삭제

불필요한 얼굴 데이터를 삭제하려면:
1. `faces/` 디렉토리에서 해당 파일들 삭제
2. 웹 인터페이스에서 "목록 새로고침" 버튼 클릭
3. 갤러리와 드롭다운 목록에서 자동으로 제거됨

#### 새로고침 기능

- **얼굴 교체 탭**: 🔄 버튼으로 드롭다운 목록 업데이트
- **Embedding 목록 탭**: "목록 새로고침" 버튼으로 갤러리 업데이트
- **실시간 반영**: faces 폴더에 새 파일 추가 시 즉시 반영

## 🎨 고급 기능

### CodeFormer 복원

CodeFormer는 AI 기반 이미지 복원 기술로, 교체된 얼굴의 품질을 향상시킵니다.

#### 사용법
1. 얼굴 교체 시 "CodeFormer 복원 포함" 체크
2. 자동으로 복원 처리 수행
3. 더 자연스러운 결과 이미지 생성

#### 특징
- **자동 얼굴 영역 확장**: 교체된 영역 주변도 함께 복원
- **GPU 가속**: CUDA를 통한 고속 처리
- **품질 향상**: 블러, 노이즈, 압축 아티팩트 제거

### 드래그 앤 드롭 기능

#### 이미지 교체
- 기존 이미지가 업로드된 상태에서도 새로운 이미지 드래그 가능
- X 버튼 없이 자동으로 교체
- 실시간 미리보기 제공

#### 지원 형식
- **이미지**: JPG, JPEG, PNG, GIF, BMP, TIFF, WEBP
- **한글 파일명**: 완전 지원
- **대용량 파일**: 메모리 허용 범위 내에서 처리

### 갤러리 인터페이스

#### Embedding 목록 갤러리
- **4열 2행 레이아웃**: 깔끔한 이미지 배치
- **파일명 표시**: 각 이미지에 파일명이 캡션으로 표시
- **미리보기 기능**: 이미지 클릭 시 확대 미리보기
- **자동 정렬**: 파일명 기준 알파벳 순 정렬

#### 갤러리 사용법
1. "Embedding 목록" 탭으로 이동
2. 저장된 모든 얼굴 이미지를 갤러리로 확인
3. "목록 새로고침" 버튼으로 최신 상태 유지
4. 이미지 클릭으로 확대 미리보기

## ⚙️ 설정 및 최적화

### 환경 설정 (.env)

```env
# GPU 사용 설정
USE_GPU=true

# 모델 경로 설정
MODELS_PATH=./models

# 결과 이미지 저장 경로
OUTPUT_PATH=./outputs

# 얼굴 임베딩 저장 경로
FACES_PATH=./faces

# Gradio 서버 설정
GRADIO_SERVER_PORT=7860
```

### 성능 최적화

#### GPU 사용 권장
- **처리 속도**: CPU 대비 5-10배 빠름
- **메모리 효율성**: 대용량 이미지 처리 가능
- **품질**: 더 정확한 얼굴 탐지 및 교체

#### 메모리 관리
- **이미지 크기**: 4K 이상 이미지는 자동 리사이징
- **배치 처리**: 여러 얼굴 동시 처리
- **캐싱**: 임베딩 데이터 재사용

## 🐛 문제 해결

### 자주 발생하는 문제

#### 1. 이미지 업로드 실패

**증상**: "이미지를 로드할 수 없습니다" 오류

**해결방법**:
- 파일 형식 확인 (JPG, PNG 등 지원 형식)
- 파일 크기 확인 (너무 큰 파일은 리사이징)
- 파일 경로에 특수문자 없는지 확인

#### 2. 얼굴 탐지 실패

**증상**: "얼굴을 찾을 수 없습니다" 메시지

**해결방법**:
- 이미지 품질 확인 (너무 작거나 흐린 이미지)
- 얼굴이 명확히 보이는 이미지 사용
- 조명이 충분한 이미지 권장

#### 3. GPU 메모리 부족

**증상**: CUDA out of memory 오류

**해결방법**:
- 이미지 크기 축소
- CPU 모드로 전환 (`USE_GPU=false`)
- 다른 GPU 프로그램 종료

#### 4. 한글 파일명 문제

**증상**: 파일명이 깨져서 표시

**해결방법**:
- 애플리케이션에서 자동으로 안전한 파일명으로 변환
- 변환된 파일명으로 저장됨

### 로그 확인

문제 발생 시 터미널에서 로그를 확인하세요:

```bash
# 실시간 로그 확인
python gradio_face_manager.py

# 로그 파일 확인 (있는 경우)
cat logs/app.log
```

### 성능 문제

#### 느린 처리 속도
1. GPU 사용 확인
2. 이미지 크기 최적화
3. 불필요한 프로그램 종료

#### 메모리 사용량 높음
1. 이미지 크기 축소
2. 배치 크기 조정
3. 시스템 메모리 확인

## 💡 팁과 요령

### 최적의 결과를 위한 팁

1. **고품질 이미지 사용**
   - 해상도: 512x512 이상 권장
   - 조명: 균일하고 충분한 조명
   - 각도: 정면 또는 약간의 측면

2. **얼굴 인덱스 활용**
   - 특정 얼굴만 교체하여 자연스러운 결과
   - 여러 번 시도하여 최적의 조합 찾기

3. **CodeFormer 활용**
   - 교체 후 품질 향상을 위해 항상 사용 권장
   - 특히 저화질 이미지에서 효과적

### 워크플로우 예시

#### 새로운 얼굴 데이터베이스 구축
1. 다양한 각도와 표정의 얼굴 이미지 수집
2. 얼굴 추출 기능으로 각각 추출
3. 의미있는 파일명으로 저장
4. 얼굴 교체에서 활용

#### 대량 이미지 처리
1. 타겟 이미지 준비
2. 얼굴 인덱스로 원하는 얼굴만 선택
3. CodeFormer로 품질 향상
4. 결과 이미지 저장 및 확인

## 📞 지원

추가 도움이 필요하시면:
1. 이슈 생성
2. 로그 파일 첨부
3. 재현 단계 상세 설명



