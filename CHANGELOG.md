# Changelog

Face Swap Application의 변경 사항을 기록합니다.

## [1.2.0] - 2024-09-09

### 🎨 UI/UX 개선

#### ✨ 새로운 기능
- **입 원본유지 기능**: 얼굴 교체 후 입 부분을 원본 이미지로 복원하는 고급 기능
  - 혀를 내밀거나 입에 물체가 있는 경우 왜곡 방지
  - 확장 비율, 크기 조정, 위치 조정 등 세밀한 설정 가능
  - 106포인트, 68포인트, 5포인트 랜드마크 모두 지원
- **결과 이미지 삭제**: 생성된 결과 이미지 파일 삭제 및 화면 초기화 기능
  - 가장 최근 생성된 파일 자동 선택
  - 삭제 후 화면 자동 초기화
  - 삭제 성공/실패 상태 메시지 표시
- **스마트 얼굴 인덱싱**: 박스 안쪽에 큰 폰트로 표시되는 직관적인 얼굴 번호
  - 박스 크기에 비례한 적응형 폰트 크기 (1.5~4.0)
  - 흰색 배경과 검은색 텍스트로 가독성 향상
  - 박스 중앙에 정확히 배치

#### 🔧 개선사항
- **처리 순서 최적화**: `swap -> CodeFormer 복구 -> 입원본복구` 순서로 변경
  - 더 나은 품질: CodeFormer로 먼저 복원한 후 입 부분만 선택적으로 원본으로 복구
  - 자연스러운 결과: CodeFormer 복원의 이점을 유지하면서 입 부분만 원본 유지
- **입 마스크 생성**: 다양한 랜드마크 포인트 수에 대한 지원
  - 106포인트: 정확한 입 영역 마스킹
  - 68포인트: 표준 얼굴 랜드마크 지원
  - 5포인트: 기본 키포인트로 타원형 마스크 생성
- **UI 구성 개선**: 입 원본유지 설정을 위한 전용 그룹 추가
  - 체크박스로 기능 활성화/비활성화
  - 슬라이더로 세밀한 파라미터 조정
  - 동적 UI 표시/숨김 기능

#### 🐛 버그 수정
- **랜드마크 접근 오류**: `preserve_mouth` 변수 정의 오류 수정
- **use_parse 파라미터**: 지원되지 않는 `use_parse` 파라미터 제거
- **처리 순서 오류**: 입 원본유지와 CodeFormer 복원 순서 최적화

#### 📚 문서 업데이트
- **README.md**: 새로운 기능들에 대한 상세한 설명 추가
- **프로젝트 구조**: `mouth_mask.py` 유틸리티 파일 추가
- **사용법 가이드**: 입 원본유지 기능 사용법 추가

---

## [1.1.0] - 2024-09-07

### 🎨 UI/UX 개선

#### ✨ 새로운 기능
- **갤러리 인터페이스**: Embedding 목록을 이미지 갤러리로 표시
- **실시간 새로고침**: 새로고침 버튼으로 목록 즉시 업데이트
- **자동 기본 선택**: 첫 번째 저장된 얼굴을 기본값으로 자동 선택
- **Gradio 최신 API**: `gr.update()` 사용으로 안정적인 드롭다운 업데이트

#### 🔧 개선사항
- **Embedding 목록 탭**: 텍스트 목록에서 이미지 갤러리로 변경
- **4열 2행 레이아웃**: 깔끔한 이미지 배치
- **파일명 캡션**: 각 이미지에 파일명 표시
- **미리보기 기능**: 이미지 클릭 시 확대 미리보기
- **새로고침 버튼**: 🔄 아이콘으로 직관적인 UI

#### 🐛 버그 수정
- **드롭다운 업데이트**: `gr.Dropdown.update()` 오류 해결
- **실시간 목록 반영**: faces 폴더 변경사항 즉시 반영
- **Gradio 호환성**: 최신 Gradio 버전과의 호환성 개선

#### 📚 문서 업데이트
- **README.md**: 프로젝트 구조 및 파일 트리 상세 업데이트
- **USER_GUIDE.md**: 갤러리 기능 및 새로고침 기능 가이드 추가
- **API_REFERENCE.md**: 실제 구현된 클래스와 메서드 반영

---

## [1.0.0] - 2024-09-07

### 🎉 초기 릴리스

#### ✨ 새로운 기능
- **얼굴 탐지**: Buffalo_L 모델을 이용한 고정밀 얼굴 탐지
- **얼굴 교체**: inswapper_128.onnx 모델을 이용한 자연스러운 얼굴 교체
- **이미지 복원**: codeformer-v0.1.0.pth 모델을 이용한 이미지 품질 향상
- **웹 UI**: Gradio를 이용한 사용자 친화적인 웹 인터페이스
- **드래그 앤 드롭**: 직관적인 이미지 업로드 및 교체
- **실시간 미리보기**: 업로드된 이미지 즉시 표시

#### 🎯 얼굴 인덱스 시스템
- **정렬 기준**: 왼쪽에서 오른쪽으로, x좌표가 동일하면 위에서 아래 순서
- **사용자 친화적**: 1-based 인덱스 (1, 2, 3, ...)
- **자동 변환**: UI 입력을 내부 0-based 인덱스로 자동 변환
- **일관성**: face detection, swap, restoring 모든 과정에서 동일한 순서 적용

#### 🎨 사용자 경험
- **자동 이미지 교체**: 새로운 이미지 드래그 시 기존 이미지 자동 교체
- **한글 파일명 지원**: PIL을 통한 안전한 파일 처리
- **색상 공간 일관성**: RGB/BGR 변환 최적화로 파란색 얼굴 문제 해결
- **CodeFormer 기본 활성화**: 체크박스 기본값으로 설정

#### 🏗️ 아키텍처
- **SOLID 원칙 준수**: 유지보수 가능한 코드 구조
- **TDD 개발**: 테스트 주도 개발 방식 적용
- **모듈화 설계**: 각 기능별 독립적인 서비스
- **인터페이스 분리**: ISP 원칙에 따른 작고 구체적인 인터페이스

#### 🔧 기술적 특징
- **GPU 가속**: CUDA를 통한 고속 처리
- **메모리 효율성**: 필요한 모델만 로드
- **배치 처리**: 여러 얼굴 동시 처리
- **에러 처리**: 포괄적인 예외 처리 및 로깅

#### 📁 파일 구조
```
src/
├── interfaces/          # SOLID 원칙의 ISP 적용
│   ├── face_detector.py
│   ├── face_swapper.py
│   ├── image_enhancer.py
│   └── image_processor.py
├── services/           # SRP 원칙 적용
│   ├── buffalo_detector.py      # Buffalo_L 얼굴 탐지
│   ├── inswapper_detector.py    # inswapper 얼굴 교체
│   └── codeformer_enhancer.py   # CodeFormer 이미지 복원
└── utils/              # 공통 유틸리티
    └── config.py

gradio_face_manager.py  # 메인 Gradio UI 애플리케이션
face_swap_demo.py       # 데모 스크립트
```

#### 🧪 테스트
- **단위 테스트**: 각 서비스별 독립적인 테스트
- **통합 테스트**: 전체 워크플로우 테스트
- **Mock 사용**: 외부 의존성 격리
- **커버리지**: 90% 이상 테스트 커버리지

#### 📚 문서화
- **README.md**: 프로젝트 개요 및 빠른 시작 가이드
- **API_REFERENCE.md**: 상세한 API 문서
- **USER_GUIDE.md**: 사용자 가이드
- **DEVELOPER_GUIDE.md**: 개발자 가이드
- **GPU_INSTALLATION.md**: GPU 설치 가이드

#### ⚙️ 설정
- **환경 변수**: .env 파일을 통한 유연한 설정
- **모델 경로**: 사용자 정의 모델 경로 지원
- **출력 경로**: 결과 이미지 저장 위치 설정
- **GPU 설정**: CPU/GPU 모드 선택 가능

#### 🎮 사용자 인터페이스
- **3개 탭 구조**: 얼굴 교체, 얼굴 추출, Embedding 목록
- **직관적 UI**: 드래그 앤 드롭 및 실시간 미리보기
- **동적 드롭다운**: 저장된 얼굴 목록 자동 업데이트
- **상태 관리**: Gradio State를 통한 이미지 상태 유지

#### 🔄 워크플로우
1. **얼굴 추출**: 이미지에서 첫 번째 얼굴 자동 추출 및 저장
2. **얼굴 교체**: 타겟 이미지의 선택된 얼굴들을 소스 얼굴로 교체
3. **이미지 복원**: CodeFormer를 통한 선택적 품질 향상
4. **결과 저장**: 최종 이미지를 타임스탬프와 함께 저장

#### 🐛 버그 수정
- **한글 파일명**: cv2.imread 한계를 PIL로 해결
- **색상 공간**: RGB/BGR 변환 최적화로 색상 일관성 확보
- **이미지 교체**: gr.Image 컴포넌트로 자동 교체 기능 구현
- **상태 관리**: CodeFormer 복원 시 올바른 이미지 처리

#### 🚀 성능 최적화
- **GPU 활용**: CUDA를 통한 5-10배 속도 향상
- **메모리 관리**: 대용량 이미지 처리 최적화
- **캐싱**: 임베딩 데이터 재사용
- **비동기 처리**: UI 응답성 향상

#### 📦 의존성
- **핵심 라이브러리**: 
  - gradio 5.44.1
  - insightface
  - onnxruntime-gpu
  - torch, torchvision
  - opencv-python
  - numpy
  - pillow
- **CodeFormer 관련**:
  - codeformer-pip
  - basicsr
  - facexlib
  - gfpgan
  - realesrgan

#### 🔧 개발 도구
- **테스트**: pytest, pytest-cov, pytest-mock
- **코드 품질**: black, flake8, mypy
- **문서화**: 자동 생성된 API 문서
- **버전 관리**: Git을 통한 체계적인 버전 관리

#### 📋 시스템 요구사항
- **최소 요구사항**:
  - Python 3.8+ (3.10 권장)
  - RAM 8GB 이상
  - 저장공간 5GB 이상
- **권장 요구사항**:
  - NVIDIA GPU (GTX 1060 이상)
  - VRAM 6GB 이상 (8GB 이상 권장)
  - CUDA 11.8 또는 12.1+
  - RAM 16GB 이상

#### 🎯 주요 특징
- **정확성**: Buffalo_L 모델의 고정밀 얼굴 탐지
- **자연스러움**: inswapper의 고품질 얼굴 교체
- **품질 향상**: CodeFormer의 AI 기반 이미지 복원
- **사용 편의성**: 직관적인 웹 인터페이스
- **확장성**: SOLID 원칙에 따른 모듈화 설계

#### 🔮 향후 계획
- **새로운 모델 지원**: 다양한 얼굴 탐지 및 교체 모델 추가
- **배치 처리**: 여러 이미지 동시 처리 기능
- **API 서버**: REST API 서버 제공
- **클라우드 배포**: Docker 및 클라우드 배포 지원
- **모바일 지원**: 모바일 친화적 UI 개선

---

## 개발 노트

### 주요 기술적 결정사항

1. **SOLID 원칙 적용**: 유지보수성과 확장성을 위한 아키텍처 설계
2. **TDD 개발**: 테스트 주도 개발로 안정성 확보
3. **GPU 우선**: 성능을 위한 GPU 가속 활용
4. **사용자 중심**: 직관적인 UI/UX 설계
5. **모듈화**: 각 기능별 독립적인 서비스 구조

### 성능 벤치마크

- **CPU 모드**: 1024x1024 이미지 기준 약 30초
- **GPU 모드**: 1024x1024 이미지 기준 약 3-5초
- **메모리 사용량**: 평균 2-4GB (GPU 모드)
- **정확도**: 얼굴 탐지 95% 이상, 교체 품질 우수

### 알려진 제한사항

1. **모델 크기**: 대용량 모델로 인한 초기 로딩 시간
2. **GPU 메모리**: 대용량 이미지 처리 시 VRAM 부족 가능
3. **한글 파일명**: 일부 특수문자에서 제한적 지원
4. **배치 처리**: 현재 단일 이미지 처리만 지원

### 기여자

- **개발**: AI Assistant (Claude)
- **테스트**: 사용자 피드백 기반
- **문서화**: 포괄적인 사용자 및 개발자 가이드

### 라이선스

MIT License - 자유로운 사용, 수정, 배포 가능



